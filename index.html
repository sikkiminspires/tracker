<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Previous head content remains the same -->
    <!-- Add Firebase and document generation libraries -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-storage-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docx/7.1.0/docx.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.19.0/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3.2.0/dist/email.min.js"></script>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sikkim INSPIRES Programme Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: #f9fafb;
            line-height: 1.5;
            color: #374151;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1rem;
        }
        
        .header {
            background: white;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .header h1 {
            font-size: 2rem;
            font-weight: bold;
            color: #111827;
        }
        
        .header p {
            color: #6b7280;
            margin-top: 0.25rem;
        }
        
        .btn {
            background: #2563eb;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            cursor: pointer;
            font-size: 0.875rem;
            transition: background-color 0.2s;
        }
        
        .btn:hover {
            background: #1d4ed8;
        }
        
        .btn-secondary {
            background: #6b7280;
        }
        
        .btn-secondary:hover {
            background: #4b5563;
        }
        
        .btn-danger {
            background: #dc2626;
        }
        
        .btn-danger:hover {
            background: #b91c1c;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1.5rem;
        }
        
        .stat-card {
            padding: 1rem;
            border-radius: 0.5rem;
            border: 1px solid;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .stat-total { background: #dbeafe; border-color: #bfdbfe; color: #1e40af; }
        .stat-overdue { background: #fef2f2; border-color: #fecaca; color: #b91c1c; }
        .stat-urgent { background: #fff7ed; border-color: #fed7aa; color: #c2410c; }
        .stat-completed { background: #f0fdf4; border-color: #bbf7d0; color: #16a34a; }
        
        .stat-number {
            font-size: 1.5rem;
            font-weight: bold;
        }
        
        .filters {
            background: white;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }
        
        .search-box {
            position: relative;
        }
        
        .search-input {
            width: 100%;
            padding: 0.5rem 0.5rem 0.5rem 2.5rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            font-size: 0.875rem;
        }
        
        .search-icon {
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: #9ca3af;
            width: 1rem;
            height: 1rem;
        }
        
        select, input {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            font-size: 0.875rem;
        }
        
        .table-container {
            background: white;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
            overflow: hidden;
        }
        
        .table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .table th {
            background: #f9fafb;
            padding: 0.75rem 1rem;
            text-align: left;
            font-weight: 500;
            font-size: 0.875rem;
            color: #111827;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .table td {
            padding: 1rem;
            border-bottom: 1px solid #e5e7eb;
            font-size: 0.875rem;
            vertical-align: top;
        }
        
        .table tr:hover {
            background: #f9fafb;
        }
        
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.625rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
            border: 1px solid;
        }
        
        .badge-dept {
            background: #dbeafe;
            color: #1e40af;
            border-color: #bfdbfe;
        }
        
        .badge-overdue {
            background: #fef2f2;
            color: #b91c1c;
            border-color: #fecaca;
        }
        
        .badge-urgent {
            background: #fff7ed;
            color: #c2410c;
            border-color: #fed7aa;
        }
        
        .badge-high {
            background: #fefce8;
            color: #a16207;
            border-color: #fde047;
        }
        
        .badge-medium {
            background: #dbeafe;
            color: #1e40af;
            border-color: #bfdbfe;
        }
        
        .badge-low {
            background: #f3f4f6;
            color: #374151;
            border-color: #d1d5db;
        }
        
        .actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            padding: 1rem;
        }
        
        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: white;
            border-radius: 0.5rem;
            padding: 1.5rem;
            width: 100%;
            max-width: 42rem;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }
        
        .form-group label {
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151;
        }
        
        textarea {
            resize: vertical;
            min-height: 4rem;
        }
        
        .btn-group {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }
        
        .btn-group .btn {
            flex: 1;
        }
        
        .empty-state {
            text-align: center;
            padding: 2rem;
            color: #6b7280;
        }
        
        .text-xs {
            font-size: 0.75rem;
        }
        
        .text-red {
            color: #dc2626;
        }
        
        .text-orange {
            color: #ea580c;
        }
        
        .text-green {
            color: #16a34a;
        }
        
        .text-gray {
            color: #6b7280;
        }
        
        .text-blue {
            color: #2563eb;
        }
        
        .font-medium {
            font-weight: 500;
        }
        
        .mt-1 {
            margin-top: 0.25rem;
        }
        
        .hidden {
            display: none !important;
        }
        
        .user-info {
            background: #1f2937;
            color: white;
            padding: 0.5rem 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.875rem;
        }
        
        .user-role {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .role-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .role-admin {
            background: #10b981;
            color: white;
        }
        
        .role-operator {
            background: #f59e0b;
            color: white;
        }
        
        .role-viewer {
            background: #6b7280;
            color: white;
        }
        
        .login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        
        .login-card {
            background: white;
            border-radius: 0.5rem;
            padding: 2rem;
            width: 100%;
            max-width: 450px;
            text-align: center;
        }
        
        .login-form {
            text-align: left;
            margin-top: 1.5rem;
        }
        
        .form-field {
            margin-bottom: 1rem;
        }
        
        .form-field label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #374151;
        }
        
        .form-field input, .form-field select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            font-size: 0.875rem;
        }
        
        .form-field input:focus, .form-field select:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        
        .access-info {
            background: #f3f4f6;
            border-radius: 0.375rem;
            padding: 1rem;
            margin: 1rem 0;
            font-size: 0.875rem;
            text-align: left;
        }
        
        .access-info h4 {
            margin: 0 0 0.5rem 0;
            color: #374151;
        }
        
        .settings-dropdown {
            position: relative;
            display: inline-block;
        }
        
        .settings-menu {
            position: absolute;
            right: 0;
            top: 100%;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.375rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 0.5rem 0;
            min-width: 180px;
            z-index: 1000;
            display: none;
        }
        
        .settings-menu.show {
            display: block;
        }
        
        .settings-menu button {
            width: 100%;
            text-align: left;
            padding: 0.5rem 1rem;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 0.875rem;
            color: #374151;
        }
        
        .settings-menu button:hover {
            background: #f9fafb;
        }
        
        .error-message {
            color: #dc2626;
            font-size: 0.875rem;
            margin-top: 0.5rem;
            padding: 0.5rem;
            background: #fef2f2;
            border-radius: 0.25rem;
            display: none;
        }
        
        .success-message {
            color: #16a34a;
            font-size: 0.875rem;
            margin-top: 0.5rem;
            padding: 0.5rem;
            background: #f0fdf4;
            border-radius: 0.25rem;
            display: none;
        }
        
        .password-strength {
            margin-top: 0.5rem;
            font-size: 0.75rem;
        }
        
        .strength-weak { color: #dc2626; }
        .strength-medium { color: #f59e0b; }
        .strength-strong { color: #16a34a; }
        
        .permission-warning {
            background: #fef3c7;
            color: #92400e;
            padding: 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.875rem;
            margin: 0.5rem 0;
            display: none;
        }
        
        .main-nav {
            background: white;
            border-bottom: 1px solid #e5e7eb;
            padding: 0;
        }
        
        .nav-tabs {
            display: flex;
            gap: 0;
            border-bottom: none;
        }
        
        .nav-tab {
            padding: 1rem 1.5rem;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            color: #6b7280;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }
        
        .nav-tab:hover {
            color: #374151;
            background: #f9fafb;
        }
        
        .nav-tab.active {
            color: #2563eb;
            border-bottom-color: #2563eb;
            background: white;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .meeting-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .meeting-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .meeting-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: #111827;
        }
        
        .meeting-date {
            color: #6b7280;
            font-size: 0.875rem;
        }
        
        .meeting-section {
            margin-bottom: 1rem;
        }
        
        .meeting-section h4 {
            font-size: 0.875rem;
            font-weight: 600;
            color: #374151;
            margin-bottom: 0.5rem;
        }
        
        .meeting-section p {
            font-size: 0.875rem;
            color: #6b7280;
            line-height: 1.5;
        }
        
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                align-items: stretch;
            }
            
            .table-container {
                overflow-x: auto;
            }
            
            .modal {
                padding: 0.5rem;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .user-info {
                flex-direction: column;
                gap: 0.5rem;
                align-items: stretch;
            }
            
            .nav-tabs {
                flex-wrap: wrap;
            }
            
            .nav-tab {
                padding: 0.75rem 1rem;
                font-size: 0.8rem;
            }
        }

        /* Add debugging and status styles */
        .debug-info {
            background: #f0f9ff;
            border: 1px solid #0ea5e9;
            padding: 0.5rem;
            margin: 0.5rem 0;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            color: #0c4a6e;
        }

        .status-message {
            padding: 0.75rem;
            border-radius: 0.375rem;
            margin: 1rem 0;
            font-size: 0.875rem;
        }

        .status-success {
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
            color: #166534;
        }

        .status-error {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: #dc2626;
        }
    </style>
</head>
<body>
    <!-- Login Overlay -->
    <div class="login-overlay" id="loginOverlay">
        <div class="login-card">
            <h2>Sikkim INSPIRES Access Control</h2>
            <p>Please enter your credentials to access the system</p>
            
            <div class="access-info">
                <h4>Access Information:</h4>
                <div>Please contact your system administrator for login credentials.</div>
            </div>
            
            <div class="login-form">
                <div class="form-field">
                    <label for="loginUsername">Username</label>
                    <input type="text" id="loginUsername" placeholder="Enter your username">
                </div>
                
                <div class="form-field">
                    <label for="loginPassword">Password</label>
                    <input type="password" id="loginPassword" placeholder="Enter password">
                </div>
                
                <div class="error-message" id="loginError"></div>
                
                <button class="btn" onclick="login()" id="loginBtn" style="width: 100%; margin-top: 1rem;">
                    Login
                </button>
            </div>
        </div>
    </div>

    <!-- Change Password Modal -->
    <div class="modal" id="changePasswordModal">
        <div class="modal-content">
            <h2>Change Password</h2>
            <div class="form-field">
                <label for="currentPassword">Current Password</label>
                <input type="password" id="currentPassword" placeholder="Enter current password">
            </div>
            <div class="form-field">
                <label for="newPassword">New Password</label>
                <input type="password" id="newPassword" placeholder="Enter new password" oninput="checkPasswordStrength()">
                <div class="password-strength" id="passwordStrength"></div>
            </div>
            <div class="form-field">
                <label for="confirmPassword">Confirm New Password</label>
                <input type="password" id="confirmPassword" placeholder="Confirm new password">
            </div>
            <div class="error-message" id="passwordError"></div>
            <div class="success-message" id="passwordSuccess"></div>
            <div class="btn-group">
                <button class="btn" onclick="changePassword()">Change Password</button>
                <button class="btn btn-secondary" onclick="hideChangePasswordModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- User Info Bar -->
    <div class="user-info">
        <div class="user-role">
            <span>Current User:</span>
            <span class="role-badge" id="userRoleBadge">System Administrator</span>
            <span id="userName">Admin User</span>
        </div>
        <div class="settings-dropdown">
            <button class="btn btn-sm btn-secondary" onclick="toggleSettingsMenu()">
                ⚙️ Settings ▼
            </button>
            <div class="settings-menu" id="settingsMenu">
                <button onclick="showChangePasswordModal()">🔒 Change Password</button>
                <button onclick="logout()">🚪 Logout</button>
            </div>
        </div>
    </div>

    <!-- Navigation Tabs -->
    <div class="main-nav">
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('tasks')">📋 Tasks Management</button>
            <button class="nav-tab" onclick="switchTab('meetings')">📄 Meeting Minutes</button>
        </div>
    </div>

    <div class="container">
        <!-- Status Messages -->
        <div id="statusMessages"></div>

        <!-- Tasks Tab Content -->
        <div id="tasksTab" class="tab-content active">
            <!-- Header -->
            <div class="header">
                <div class="header-content">
                    <div>
                        <h1>Sikkim INSPIRES</h1>
                        <p>Programme Activity Tracker</p>
                    </div>
                    <div>
                        <div class="permission-warning" id="permissionWarning">
                            ⚠️ You don't have permission to perform this action
                        </div>
                        <button class="btn" onclick="showAddTaskModal()" id="addTaskBtn">
                            <span>➕</span> Add New Task
                        </button>
                    </div>
                </div>
                
                <!-- Stats Cards -->
                <div class="stats-grid">
                    <div class="stat-card stat-total">
                        <div>
                            <div class="text-xs">Total Tasks</div>
                            <div class="stat-number" id="totalTasks">0</div>
                        </div>
                    </div>
                    <div class="stat-card stat-overdue">
                        <div>
                            <div class="text-xs">Overdue</div>
                            <div class="stat-number" id="overdueTasks">0</div>
                        </div>
                    </div>
                    <div class="stat-card stat-urgent">
                        <div>
                            <div class="text-xs">Urgent</div>
                            <div class="stat-number" id="urgentTasks">0</div>
                        </div>
                    </div>
                    <div class="stat-card stat-completed">
                        <div>
                            <div class="text-xs">Completed</div>
                            <div class="stat-number" id="completedTasks">0</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Filters -->
            <div class="filters">
                <div class="filters-grid">
                    <div class="search-box">
                        <svg class="search-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                        <input type="text" class="search-input" placeholder="Search tasks..." id="searchInput" oninput="filterTasks()">
                    </div>
                    <select id="departmentFilter" onchange="filterTasks()">
                        <option value="all">All Departments</option>
                        <option value="C&ID">C&ID</option>
                        <option value="DET">DET</option>
                        <option value="DIT">DIT</option>
                        <option value="H&FWD">H&FWD</option>
                        <option value="RDD">RDD</option>
                        <option value="SDD">SDD</option>
                        <option value="T&CAD">T&CAD</option>
                        <option value="WCDD">WCDD</option>
                    </select>
                    <select id="priorityFilter" onchange="filterTasks()">
                        <option value="all">All Priorities</option>
                        <option value="overdue">Overdue</option>
                        <option value="urgent">Urgent</option>
                        <option value="high">High</option>
                        <option value="medium">Medium</option>
                        <option value="low">Low</option>
                    </select>
                    <select id="sortBy" onchange="filterTasks()">
                        <option value="deliveryDate">Sort by Delivery Date</option>
                        <option value="department">Sort by Department</option>
                        <option value="id">Sort by ID</option>
                    </select>
                </div>
            </div>

            <!-- Tasks Table -->
            <div class="table-container">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Department</th>
                            <th>Status & Description</th>
                            <th>Timeline</th>
                            <th>Responsibility</th>
                            <th>Progress Status</th>
                            <th>Priority</th>
                            <th>Pending With</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="tasksTableBody">
                        <!-- Tasks will be populated here -->
                    </tbody>
                </table>
                <div id="emptyState" class="empty-state" style="display: none;">
                    No tasks found matching your criteria.
                </div>
            </div>
        </div>

        <!-- Meeting Minutes Tab Content -->
        <div id="meetingsTab" class="tab-content">
            <!-- Header -->
            <div class="header">
                <div class="header-content">
                    <div>
                        <h1>Meeting Minutes</h1>
                        <p>Programme Meeting Records & Minutes</p>
                    </div>
                    <div>
                        <button class="btn" onclick="showAddMeetingModal()" id="addMeetingBtn">
                            <span>➕</span> Add New Meeting
                        </button>
                    </div>
                </div>
            </div>

            <!-- Meeting Filters -->
            <div class="filters">
                <div class="filters-grid">
                    <div class="search-box">
                        <svg class="search-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                        <input type="text" class="search-input" placeholder="Search meetings..." id="meetingSearchInput" oninput="filterMeetings()">
                    </div>
                    <select id="meetingDateFilter" onchange="filterMeetings()">
                        <option value="all">All Dates</option>
                        <option value="thisWeek">This Week</option>
                        <option value="thisMonth">This Month</option>
                        <option value="lastMonth">Last Month</option>
                    </select>
                    <select id="meetingSortBy" onchange="filterMeetings()">
                        <option value="date">Sort by Date (Latest First)</option>
                        <option value="title">Sort by Title</option>
                    </select>
                </div>
            </div>

            <!-- Meeting Minutes Container -->
            <div id="meetingsContainer">
                <!-- Meeting cards will be populated here -->
            </div>

            <div id="meetingEmptyState" class="empty-state" style="display: none;">
                No meeting minutes found.
            </div>
        </div>
    </div>

    <!-- Task Modal -->
    <div class="modal" id="taskModal">
        <div class="modal-content">
            <h2 id="modalTitle">Add New Task</h2>
            <div class="form-grid">
                <div class="form-group">
                    <label for="taskDepartment">Department *</label>
                    <select id="taskDepartment" required>
                        <option value="">Select Department</option>
                        <option value="C&ID">C&ID</option>
                        <option value="DET">DET</option>
                        <option value="DIT">DIT</option>
                        <option value="H&FWD">H&FWD</option>
                        <option value="RDD">RDD</option>
                        <option value="SDD">SDD</option>
                        <option value="T&CAD">T&CAD</option>
                        <option value="WCDD">WCDD</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="taskFrom">From</label>
                    <input type="text" id="taskFrom">
                </div>
                <div class="form-group">
                    <label for="taskTo">To</label>
                    <input type="text" id="taskTo">
                </div>
                <div class="form-group">
                    <label for="taskStartDate">Start Date *</label>
                    <input type="date" id="taskStartDate" required>
                </div>
                <div class="form-group">
                    <label for="taskDeliveryDate">Delivery Date</label>
                    <input type="date" id="taskDeliveryDate">
                </div>
                <div class="form-group">
                    <label for="taskPriority">Priority</label>
                    <select id="taskPriority">
                        <option value="auto">Auto (Based on Delivery Date)</option>
                        <option value="low">Low</option>
                        <option value="medium">Medium</option>
                        <option value="high">High</option>
                        <option value="urgent">Urgent</option>
                        <option value="overdue">Overdue</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="taskPendingWith">Pending With</label>
                    <input type="text" id="taskPendingWith" placeholder="Who is this task pending with?">
                </div>
            </div>
            <div class="form-group">
                <label for="taskStatus">Status Description *</label>
                <textarea id="taskStatus" rows="3" required placeholder="Describe the current status of this task..."></textarea>
            </div>
            <div class="form-group">
                <label for="taskRemarks">Remarks</label>
                <input type="text" id="taskRemarks" placeholder="Additional remarks or notes...">
            </div>
            <div class="form-group">
                <label for="taskProgress">Progress Details</label>
                <textarea id="taskProgress" rows="2" placeholder="Detailed progress description..."></textarea>
            </div>
            <div class="form-group">
                <label for="taskProgressDate">Progress Date</label>
                <input type="date" id="taskProgressDate">
            </div>
            <div class="form-group">
                <label for="taskNextStep">Next Step</label>
                <input type="text" id="taskNextStep" placeholder="What is the next action required?">
            </div>
            <div class="btn-group">
                <button class="btn" onclick="saveTask()">Save Task</button>
                <button class="btn btn-secondary" onclick="hideModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Meeting Modal -->
    <div class="modal" id="meetingModal">
        <div class="modal-content">
            <h2 id="meetingModalTitle">Add New Meeting</h2>
            <div class="form-grid">
                <div class="form-group">
                    <label for="meetingTitle">Meeting Title *</label>
                    <input type="text" id="meetingTitle" placeholder="Enter meeting title" required>
                </div>
                <div class="form-group">
                    <label for="meetingDate">Meeting Date *</label>
                    <input type="datetime-local" id="meetingDate" required>
                </div>
                <div class="form-group">
                    <label for="meetingDepartments">Departments Involved</label>
                    <input type="text" id="meetingDepartments" placeholder="e.g., C&ID, DIT, PMU">
                </div>
                <div class="form-group">
                    <label for="meetingChairperson">Chairperson</label>
                    <input type="text" id="meetingChairperson" placeholder="Meeting chairperson">
                </div>
            </div>
            <div class="form-group">
                <label for="meetingAttendees">Attendees *</label>
                <textarea id="meetingAttendees" rows="3" placeholder="List of attendees..." required></textarea>
            </div>
            <div class="form-group">
                <label for="meetingObjective">Meeting Objective *</label>
                <textarea id="meetingObjective" rows="2" placeholder="Purpose/objective of the meeting..." required></textarea>
            </div>
            <div class="form-group">
                <label for="meetingDiscussion">Key Discussion Points</label>
                <textarea id="meetingDiscussion" rows="4" placeholder="Summary of key discussion points..."></textarea>
            </div>
            <div class="form-group">
                <label for="meetingDecisions">Decisions Made</label>
                <textarea id="meetingDecisions" rows="3" placeholder="Key decisions and outcomes..."></textarea>
            </div>
            <div class="form-group">
                <label for="meetingActionItems">Action Items</label>
                <textarea id="meetingActionItems" rows="4" placeholder="Action items with responsible persons and deadlines..."></textarea>
            </div>
            <div class="form-group">
                <label for="meetingNextSteps">Next Steps</label>
                <textarea id="meetingNextSteps" rows="2" placeholder="Next meeting date, follow-up actions..."></textarea>
            </div>
            <div class="btn-group">
                <button class="btn" onclick="saveMeeting()">Save Meeting</button>
                <button class="btn btn-secondary" onclick="hideMeetingModal()">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // User Database with Password Authentication
        let userDatabase = {
            admin: {
                password: 'admin123',
                role: 'admin',
                name: 'System Administrator',
                lastLogin: null
            },
            operator: {
                password: 'op123',
                role: 'operator', 
                name: 'Data Entry Operator',
                lastLogin: null
            },
            viewer: {
                password: 'view123',
                role: 'viewer',
                name: 'Viewer',
                lastLogin: null
            }
        };

        // User Access Control System
        let currentUser = {
            username: null,
            role: null,
            name: '',
            permissions: {}
        };

        const roleConfig = {
            admin: {
                name: 'System Administrator',
                badge: 'role-admin',
                permissions: {
                    view: true,
                    add: true,
                    edit: true,
                    delete: true,
                    changePassword: true
                }
            },
            operator: {
                name: 'Data Entry Operator',
                badge: 'role-operator',
                permissions: {
                    view: true,
                    add: true,
                    edit: false,
                    delete: false,
                    changePassword: true
                }
            },
            viewer: {
                name: 'Viewer',
                badge: 'role-viewer',
                permissions: {
                    view: true,
                    add: false,
                    edit: false,
                    delete: false,
                    changePassword: true
                }
            }
        };

        // Meeting Minutes Data
        let meetings = [
            {
                id: 1,
                title: "Project Review Meeting - August 2025",
                date: "2025-08-06T10:00",
                departments: "PMU, C&ID, DIT, RDD, SDD",
                chairperson: "Project Director",
                attendees: "Project Director, TSA representatives from all departments, World Bank team",
                objective: "Review progress of all components and address key issues",
                discussion: "Progress updates from all departments were presented. Key discussion around DLR achievements, timeline challenges, and coordination between departments.",
                decisions: "Timeline adjustments approved for IEIAP district plans. Digital readiness training plan to be expedited.",
                actionItems: "1. TSA-SDD to submit skill gap study RFP by August 20th\n2. DIT to follow up with IVA for DLR verification\n3. C&ID to expedite NPA data collection from banks",
                nextSteps: "Next review meeting scheduled for August 25th during World Bank visit"
            },
            {
                id: 2,
                title: "Technical Working Group - Digital Infrastructure",
                date: "2025-08-08T14:00",
                departments: "DIT, PMU",
                chairperson: "Chief Secretary IT",
                attendees: "DIT officials, PMU team, TSA-DIT",
                objective: "Discuss State Data Centre DPR and digital readiness training implementation",
                discussion: "Review of feasibility study report for State Data Centre. Discussion on training vendor selection and implementation timeline.",
                decisions: "DPR preparation to proceed with selected vendor. Training calendar to be finalized within one week.",
                actionItems: "1. DIT to clarify DPR proposal status\n2. Vendor to submit detailed training plan\n3. Letters to be sent to all departments for training nominations",
                nextSteps: "Follow-up meeting with vendor next week to finalize training schedule"
            }
        ];

        // Current active tab
        let activeTab = 'tasks';
        let currentEditMeetingId = null;

        // Initial data - sample tasks
        let tasks = [
            {
                id: 1,
                department: "C&ID",
                status: "Convergence discussion between EEPF and Innovation Hub completed and TSA has shared the Scope of Work for Lead Incubation Partner with PMU for review.",
                remarks: "With PMU",
                from: "PMU",
                to: "C&ID",
                startDate: "2025-08-06",
                deliveryDate: "2025-08-20",
                progressDetails: "Initial discussions completed",
                progressDate: "2025-08-06",
                priority: "auto",
                pendingWith: "PMU",
                nextStep: "Await PMU review"
            },
            {
                id: 2,
                department: "DIT",
                status: "Digital readiness training - Approval from HCM received and work order has been issued to the identified vendor.",
                remarks: "Training plan awaited, timelines to be fixed",
                from: "Vendor",
                to: "DIT",
                startDate: "2025-08-06",
                deliveryDate: "2025-08-25",
                progressDetails: "Work order issued to vendor",
                progressDate: "2025-08-07",
                priority: "auto",
                pendingWith: "Vendor",
                nextStep: "Await training plan from vendor"
            }
        ];

        let currentEditId = null;

        // Utility function to show status messages
        function showStatusMessage(message, type = 'success') {
            const container = document.getElementById('statusMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `status-message status-${type}`;
            messageDiv.textContent = message;
            
            container.appendChild(messageDiv);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.parentNode.removeChild(messageDiv);
                }
            }, 5000);
        }

        // Tab switching function
        function switchTab(tabName) {
            // Remove active class from all tabs and content
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // Add active class to selected tab and content
            event.target.classList.add('active');
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            activeTab = tabName;
            
            // Initialize content based on active tab
            if (tabName === 'tasks') {
                renderTasks();
                updateStats();
            } else if (tabName === 'meetings') {
                renderMeetings();
                updateMeetingInterface();
            }
        }

        // Meeting Functions
        function renderMeetings(meetingsToRender = meetings) {
            const container = document.getElementById('meetingsContainer');
            const emptyState = document.getElementById('meetingEmptyState');
            
            if (meetingsToRender.length === 0) {
                container.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }
            
            emptyState.style.display = 'none';
            
            container.innerHTML = meetingsToRender.map(meeting => {
                const meetingDate = new Date(meeting.date);
                const formattedDate = meetingDate.toLocaleDateString('en-US', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                const formattedTime = meetingDate.toLocaleTimeString('en-US', {
                    hour: '2-digit',
                    minute: '2-digit'
                });

                // Generate action buttons based on permissions
                let actionButtons = '';
                if (hasPermission('edit')) {
                    actionButtons += `<button class="btn btn-sm" onclick="editMeeting(${meeting.id})">✏️ Edit</button>`;
                }
                if (hasPermission('delete')) {
                    actionButtons += `<button class="btn btn-danger btn-sm" onclick="deleteMeeting(${meeting.id})">🗑️ Delete</button>`;
                }

                return `
                    <div class="meeting-card">
                        <div class="meeting-header">
                            <div>
                                <div class="meeting-title">${meeting.title}</div>
                                <div class="meeting-date">${formattedDate} at ${formattedTime}</div>
                            </div>
                            <div class="actions">
                                ${actionButtons}
                            </div>
                        </div>
                        
                        <div class="meeting-section">
                            <h4>Departments: <span class="badge badge-dept">${meeting.departments}</span></h4>
                            <h4>Chairperson: ${meeting.chairperson}</h4>
                        </div>
                        
                        <div class="meeting-section">
                            <h4>Attendees</h4>
                            <p>${meeting.attendees}</p>
                        </div>
                        
                        <div class="meeting-section">
                            <h4>Meeting Objective</h4>
                            <p>${meeting.objective}</p>
                        </div>
                        
                        <div class="meeting-section">
                            <h4>Key Discussion Points</h4>
                            <p>${meeting.discussion}</p>
                        </div>
                        
                        <div class="meeting-section">
                            <h4>Decisions Made</h4>
                            <p>${meeting.decisions}</p>
                        </div>
                        
                        <div class="meeting-section">
                            <h4>Action Items</h4>
                            <p style="white-space: pre-line;">${meeting.actionItems}</p>
                        </div>
                        
                        <div class="meeting-section">
                            <h4>Next Steps</h4>
                            <p>${meeting.nextSteps}</p>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function filterMeetings() {
            const searchTerm = document.getElementById('meetingSearchInput').value.toLowerCase();
            const dateFilter = document.getElementById('meetingDateFilter').value;
            const sortBy = document.getElementById('meetingSortBy').value;
            
            let filtered = meetings.filter(meeting => {
                const matchesSearch = meeting.title.toLowerCase().includes(searchTerm) ||
                                   meeting.departments.toLowerCase().includes(searchTerm) ||
                                   meeting.discussion.toLowerCase().includes(searchTerm) ||
                                   meeting.decisions.toLowerCase().includes(searchTerm);
                
                let matchesDate = true;
                if (dateFilter !== 'all') {
                    const meetingDate = new Date(meeting.date);
                    const now = new Date();
                    
                    switch(dateFilter) {
                        case 'thisWeek':
                            const weekStart = new Date(now.setDate(now.getDate() - now.getDay()));
                            const weekEnd = new Date(now.setDate(weekStart.getDate() + 6));
                            matchesDate = meetingDate >= weekStart && meetingDate <= weekEnd;
                            break;
                        case 'thisMonth':
                            matchesDate = meetingDate.getMonth() === now.getMonth() && 
                                        meetingDate.getFullYear() === now.getFullYear();
                            break;
                        case 'lastMonth':
                            const lastMonth = new Date(now.getFullYear(), now.getMonth() - 1);
                            matchesDate = meetingDate.getMonth() === lastMonth.getMonth() && 
                                        meetingDate.getFullYear() === lastMonth.getFullYear();
                            break;
                    }
                }
                
                return matchesSearch && matchesDate;
            });

            // Sort meetings
            filtered.sort((a, b) => {
                if (sortBy === 'date') {
                    return new Date(b.date) - new Date(a.date); // Latest first
                }
                if (sortBy === 'title') {
                    return a.title.localeCompare(b.title);
                }
                return 0;
            });

            renderMeetings(filtered);
        }

        function showAddMeetingModal() {
            if (!checkPermission('add')) return;
            
            currentEditMeetingId = null;
            document.getElementById('meetingModalTitle').textContent = 'Add New Meeting';
            clearMeetingForm();
            
            // Set default date to now
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            document.getElementById('meetingDate').value = now.toISOString().slice(0, 16);
            
            document.getElementById('meetingModal').classList.add('show');
        }

        function editMeeting(id) {
            if (!checkPermission('edit')) return;
            
            const meeting = meetings.find(m => m.id === id);
            if (!meeting) return;
            
            currentEditMeetingId = id;
            document.getElementById('meetingModalTitle').textContent = 'Edit Meeting';
            
            document.getElementById('meetingTitle').value = meeting.title;
            document.getElementById('meetingDate').value = meeting.date;
            document.getElementById('meetingDepartments').value = meeting.departments;
            document.getElementById('meetingChairperson').value = meeting.chairperson;
            document.getElementById('meetingAttendees').value = meeting.attendees;
            document.getElementById('meetingObjective').value = meeting.objective;
            document.getElementById('meetingDiscussion').value = meeting.discussion;
            document.getElementById('meetingDecisions').value = meeting.decisions;
            document.getElementById('meetingActionItems').value = meeting.actionItems;
            document.getElementById('meetingNextSteps').value = meeting.nextSteps;
            
            document.getElementById('meetingModal').classList.add('show');
        }

        function deleteMeeting(id) {
            if (!checkPermission('delete')) return;
            
            if (confirm('Are you sure you want to delete this meeting record?')) {
                meetings = meetings.filter(m => m.id !== id);
                filterMeetings();
                showStatusMessage('Meeting deleted successfully!');
            }
        }

        function saveMeeting() {
            const isEditing = currentEditMeetingId !== null;
            const requiredPermission = isEditing ? 'edit' : 'add';
            
            if (!checkPermission(requiredPermission)) return;
            
            const formData = {
                title: document.getElementById('meetingTitle').value.trim(),
                date: document.getElementById('meetingDate').value,
                departments: document.getElementById('meetingDepartments').value.trim(),
                chairperson: document.getElementById('meetingChairperson').value.trim(),
                attendees: document.getElementById('meetingAttendees').value.trim(),
                objective: document.getElementById('meetingObjective').value.trim(),
                discussion: document.getElementById('meetingDiscussion').value.trim(),
                decisions: document.getElementById('meetingDecisions').value.trim(),
                actionItems: document.getElementById('meetingActionItems').value.trim(),
                nextSteps: document.getElementById('meetingNextSteps').value.trim()
            };
            
            // Validation
            if (!formData.title || !formData.date || !formData.attendees || !formData.objective) {
                showStatusMessage('Please fill in all required fields (Title, Date, Attendees, Objective)', 'error');
                return;
            }
            
            try {
                if (currentEditMeetingId) {
                    // Edit existing meeting
                    const meetingIndex = meetings.findIndex(m => m.id === currentEditMeetingId);
                    if (meetingIndex === -1) {
                        showStatusMessage('Meeting not found for editing', 'error');
                        return;
                    }
                    meetings[meetingIndex] = { ...meetings[meetingIndex], ...formData };
                    showStatusMessage('Meeting updated successfully!');
                } else {
                    // Add new meeting
                    const newMeeting = {
                        ...formData,
                        id: Math.max(...meetings.map(m => m.id), 0) + 1
                    };
                    meetings.push(newMeeting);
                    showStatusMessage('Meeting added successfully!');
                }
                
                hideMeetingModal();
                filterMeetings();
                
            } catch (error) {
                console.error('Error saving meeting:', error);
                showStatusMessage('Error saving meeting. Please try again.', 'error');
            }
        }

        function hideMeetingModal() {
            document.getElementById('meetingModal').classList.remove('show');
            clearMeetingForm();
        }

        function clearMeetingForm() {
            document.getElementById('meetingTitle').value = '';
            document.getElementById('meetingDate').value = '';
            document.getElementById('meetingDepartments').value = '';
            document.getElementById('meetingChairperson').value = '';
            document.getElementById('meetingAttendees').value = '';
            document.getElementById('meetingObjective').value = '';
            document.getElementById('meetingDiscussion').value = '';
            document.getElementById('meetingDecisions').value = '';
            document.getElementById('meetingActionItems').value = '';
            document.getElementById('meetingNextSteps').value = '';
        }

        function updateMeetingInterface() {
            const addMeetingBtn = document.getElementById('addMeetingBtn');
            
            if (hasPermission('add')) {
                addMeetingBtn.classList.remove('hidden');
            } else {
                addMeetingBtn.classList.add('hidden');
            }
        }

        // Password utilities
        function validatePassword(password) {
            const minLength = 6;
            const hasUpper = /[A-Z]/.test(password);
            const hasLower = /[a-z]/.test(password);
            const hasNumber = /\d/.test(password);
            
            if (password.length < minLength) {
                return { valid: false, message: 'Password must be at least 6 characters long' };
            }
            
            let strength = 'weak';
            let score = 0;
            
            if (password.length >= 8) score++;
            if (hasUpper) score++;
            if (hasLower) score++;
            if (hasNumber) score++;
            
            if (score >= 3) strength = 'strong';
            else if (score >= 2) strength = 'medium';
            
            return { valid: true, strength, score };
        }

        function checkPasswordStrength() {
            const password = document.getElementById('newPassword').value;
            const strengthDiv = document.getElementById('passwordStrength');
            
            if (!password) {
                strengthDiv.innerHTML = '';
                return;
            }
            
            const validation = validatePassword(password);
            
            if (!validation.valid) {
                strengthDiv.innerHTML = `<span class="strength-weak">${validation.message}</span>`;
                return;
            }
            
            const strengthClass = `strength-${validation.strength}`;
            const strengthText = validation.strength.charAt(0).toUpperCase() + validation.strength.slice(1);
            
            strengthDiv.innerHTML = `<span class="${strengthClass}">Password strength: ${strengthText}</span>`;
        }

        // Authentication functions
        function login() {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            if (!username || !password) {
                showError('loginError', 'Please enter both username and password');
                return;
            }
            
            const user = userDatabase[username];
            if (!user || user.password !== password) {
                showError('loginError', 'Invalid username or password');
                return;
            }
            
            // Successful login
            currentUser.username = username;
            currentUser.role = user.role;
            currentUser.name = user.name;
            currentUser.permissions = roleConfig[user.role].permissions;
            
            // Update last login
            userDatabase[username].lastLogin = new Date().toISOString();
            
            // Update UI
            updateUserInterface();
            
            // Hide login overlay
            document.getElementById('loginOverlay').style.display = 'none';
            
            // Initialize the app
            initializeApp();
            
            showStatusMessage(`Welcome, ${user.name}! You are logged in as ${roleConfig[user.role].name}.`);
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                currentUser = { username: null, role: null, name: '', permissions: {} };
                
                // Reset login form
                document.getElementById('loginUsername').value = '';
                document.getElementById('loginPassword').value = '';
                hideError('loginError');
                
                // Hide settings menu
                hideSettingsMenu();
                
                // Show login overlay
                document.getElementById('loginOverlay').style.display = 'flex';
            }
        }

        // Settings menu functions
        function toggleSettingsMenu() {
            const menu = document.getElementById('settingsMenu');
            menu.classList.toggle('show');
        }

        function hideSettingsMenu() {
            document.getElementById('settingsMenu').classList.remove('show');
        }

        // Change password functions
        function showChangePasswordModal() {
            hideSettingsMenu();
            document.getElementById('changePasswordModal').classList.add('show');
            // Clear form
            document.getElementById('currentPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
            document.getElementById('passwordStrength').innerHTML = '';
            hideError('passwordError');
            hideSuccess('passwordSuccess');
        }

        function hideChangePasswordModal() {
            document.getElementById('changePasswordModal').classList.remove('show');
        }

        function changePassword() {
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            // Validate current password
            if (userDatabase[currentUser.username].password !== currentPassword) {
                showError('passwordError', 'Current password is incorrect');
                return;
            }
            
            // Validate new password
            const validation = validatePassword(newPassword);
            if (!validation.valid) {
                showError('passwordError', validation.message);
                return;
            }
            
            // Check password confirmation
            if (newPassword !== confirmPassword) {
                showError('passwordError', 'New passwords do not match');
                return;
            }
            
            // Check if new password is different
            if (newPassword === currentPassword) {
                showError('passwordError', 'New password must be different from current password');
                return;
            }
            
            // Update password
            userDatabase[currentUser.username].password = newPassword;
            
            showSuccess('passwordSuccess', 'Password changed successfully!');
            
            // Clear form after 2 seconds and close modal
            setTimeout(() => {
                hideChangePasswordModal();
            }, 2000);
        }

        // Utility functions for messages
        function showError(elementId, message) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.style.display = 'block';
        }

        function hideError(elementId) {
            const element = document.getElementById(elementId);
            element.style.display = 'none';
        }

        function showSuccess(elementId, message) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.style.display = 'block';
        }

        function hideSuccess(elementId) {
            const element = document.getElementById(elementId);
            element.style.display = 'none';
        }

        // Permission Management Functions
        function hasPermission(action) {
            return currentUser.permissions && currentUser.permissions[action] === true;
        }

        function checkPermission(action) {
            if (!hasPermission(action)) {
                showPermissionWarning();
                showStatusMessage(`You don't have permission to ${action} items. Please contact your administrator.`, 'error');
                return false;
            }
            return true;
        }

        function showPermissionWarning() {
            const warning = document.getElementById('permissionWarning');
            warning.style.display = 'block';
            setTimeout(() => {
                warning.style.display = 'none';
            }, 3000);
        }

        function updateUserInterface() {
            // Update user info display
            const roleBadge = document.getElementById('userRoleBadge');
            const userName = document.getElementById('userName');
            
            roleBadge.textContent = roleConfig[currentUser.role].name;
            roleBadge.className = `role-badge ${roleConfig[currentUser.role].badge}`;
            userName.textContent = userDatabase[currentUser.username].name;
            
            // Update button visibility based on permissions
            const addTaskBtn = document.getElementById('addTaskBtn');
            
            if (hasPermission('add')) {
                addTaskBtn.classList.remove('hidden');
            } else {
                addTaskBtn.classList.add('hidden');
            }
            
            // Update interface based on active tab
            if (activeTab === 'tasks') {
                filterTasks();
            } else if (activeTab === 'meetings') {
                updateMeetingInterface();
                filterMeetings();
            }
        }

        function initializeApp() {
            if (activeTab === 'tasks') {
                renderTasks();
                updateStats();
            } else if (activeTab === 'meetings') {
                renderMeetings();
                updateMeetingInterface();
            }
        }

        // Task management functions
        function getTaskPriority(task) {
            // If priority is manually set (not "auto"), use that
            if (task.priority && task.priority !== "auto") {
                return task.priority;
            }
            
            // Otherwise calculate based on delivery date
            if (!task.deliveryDate) return 'low';
            const today = new Date();
            const delivery = new Date(task.deliveryDate);
            const daysRemaining = Math.ceil((delivery - today) / (1000 * 60 * 60 * 24));
            
            if (daysRemaining < 0) return 'overdue';
            if (daysRemaining <= 3) return 'urgent';
            if (daysRemaining <= 7) return 'high';
            return 'medium';
        }

        function getDaysRemaining(deliveryDate) {
            if (!deliveryDate) return null;
            const today = new Date();
            const delivery = new Date(deliveryDate);
            return Math.ceil((delivery - today) / (1000 * 60 * 60 * 24));
        }

        function formatDate(dateStr) {
            if (!dateStr) return 'N/A';
            return new Date(dateStr).toLocaleDateString();
        }

        function renderTasks(tasksToRender = tasks) {
            const tbody = document.getElementById('tasksTableBody');
            const emptyState = document.getElementById('emptyState');
            
            if (tasksToRender.length === 0) {
                tbody.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }
            
            emptyState.style.display = 'none';
            
            tbody.innerHTML = tasksToRender.map(task => {
                const priority = getTaskPriority(task);
                const daysRemaining = getDaysRemaining(task.deliveryDate);
                
                let timelineHtml = `<div class="text-xs text-gray">Start: ${formatDate(task.startDate)}</div>`;
                if (task.deliveryDate) {
                    timelineHtml += `<div class="text-xs">Due: ${formatDate(task.deliveryDate)}</div>`;
                }
                if (daysRemaining !== null) {
                    const timeClass = daysRemaining < 0 ? 'text-red' : daysRemaining <= 3 ? 'text-orange' : 'text-green';
                    const timeText = daysRemaining < 0 ? `${Math.abs(daysRemaining)} days overdue` : `${daysRemaining} days left`;
                    timelineHtml += `<div class="text-xs font-medium ${timeClass}">${timeText}</div>`;
                }
                
                let responsibilityHtml = '';
                if (task.from) responsibilityHtml += `<div class="text-xs"><span class="text-gray">From:</span> ${task.from}</div>`;
                if (task.to) responsibilityHtml += `<div class="text-xs"><span class="text-gray">To:</span> ${task.to}</div>`;
                
                let detailsHtml = `<div class="text-gray-900">${task.status}</div>`;
                if (task.remarks) detailsHtml += `<div class="text-xs text-gray mt-1"><strong>Remarks:</strong> ${task.remarks}</div>`;
                if (task.nextStep) detailsHtml += `<div class="text-xs text-green mt-1"><strong>Next Step:</strong> ${task.nextStep}</div>`;
                
                let progressHtml = '';
                if (task.progressDetails) {
                    progressHtml += `<div class="text-xs text-blue"><strong>Details:</strong> ${task.progressDetails}</div>`;
                }
                if (task.progressDate) {
                    progressHtml += `<div class="text-xs text-gray mt-1"><strong>Updated:</strong> ${formatDate(task.progressDate)}</div>`;
                }
                if (!progressHtml) {
                    progressHtml = '<div class="text-xs text-gray">No progress updates</div>';
                }
                
                const priorityDisplay = task.priority === 'auto' ? 
                    `${priority.charAt(0).toUpperCase() + priority.slice(1)} (Auto)` : 
                    priority.charAt(0).toUpperCase() + priority.slice(1);
                
                // Generate action buttons based on permissions
                let actionButtons = '';
                if (hasPermission('edit')) {
                    actionButtons += `<button class="btn btn-sm" onclick="editTask(${task.id})">✏️</button>`;
                }
                if (hasPermission('delete')) {
                    actionButtons += `<button class="btn btn-danger btn-sm" onclick="deleteTask(${task.id})">🗑️</button>`;
                }
                if (!actionButtons) {
                    actionButtons = '<span class="text-xs text-gray">No actions available</span>';
                }
                
                let pendingWithHtml = '';
                if (task.pendingWith) {
                    pendingWithHtml = `<div class="text-xs"><span class="badge badge-dept">${task.pendingWith}</span></div>`;
                } else {
                    pendingWithHtml = '<div class="text-xs text-gray">Not specified</div>';
                }
                
                return `
                    <tr>
                        <td>
                            <span class="badge badge-dept">${task.department}</span>
                        </td>
                        <td>${detailsHtml}</td>
                        <td>${timelineHtml}</td>
                        <td>${responsibilityHtml}</td>
                        <td>${progressHtml}</td>
                        <td>
                            <span class="badge badge-${priority}">
                                ${priorityDisplay}
                            </span>
                        </td>
                        <td>${pendingWithHtml}</td>
                        <td>
                            <div class="actions">
                                ${actionButtons}
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function updateStats() {
            const stats = {
                total: tasks.length,
                overdue: tasks.filter(t => getTaskPriority(t) === 'overdue').length,
                urgent: tasks.filter(t => getTaskPriority(t) === 'urgent').length,
                completed: tasks.filter(t => t.status.toLowerCase().includes('completed')).length
            };
            
            document.getElementById('totalTasks').textContent = stats.total;
            document.getElementById('overdueTasks').textContent = stats.overdue;
            document.getElementById('urgentTasks').textContent = stats.urgent;
            document.getElementById('completedTasks').textContent = stats.completed;
        }

        function filterTasks() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const departmentFilter = document.getElementById('departmentFilter').value;
            const priorityFilter = document.getElementById('priorityFilter').value;
            const sortBy = document.getElementById('sortBy').value;
            
            let filtered = tasks.filter(task => {
                const matchesSearch = task.status.toLowerCase().includes(searchTerm) ||
                                   task.department.toLowerCase().includes(searchTerm) ||
                                   (task.remarks && task.remarks.toLowerCase().includes(searchTerm)) ||
                                   (task.pendingWith && task.pendingWith.toLowerCase().includes(searchTerm));
                const matchesDepartment = departmentFilter === 'all' || task.department === departmentFilter;
                const matchesPriority = priorityFilter === 'all' || getTaskPriority(task) === priorityFilter;
                
                return matchesSearch && matchesDepartment && matchesPriority;
            });

            // Sort
            filtered.sort((a, b) => {
                if (sortBy === 'deliveryDate') {
                    if (!a.deliveryDate && !b.deliveryDate) return 0;
                    if (!a.deliveryDate) return 1;
                    if (!b.deliveryDate) return -1;
                    return new Date(a.deliveryDate) - new Date(b.deliveryDate);
                }
                if (sortBy === 'department') {
                    return a.department.localeCompare(b.department);
                }
                return a.id - b.id;
            });

            renderTasks(filtered);
        }

        function showAddTaskModal() {
            if (!checkPermission('add')) return;
            
            currentEditId = null;
            document.getElementById('modalTitle').textContent = 'Add New Task';
            clearForm();
            document.getElementById('taskStartDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('taskPriority').value = 'auto';
            document.getElementById('taskModal').classList.add('show');
        }

        function editTask(id) {
            if (!checkPermission('edit')) return;
            
            const task = tasks.find(t => t.id === id);
            if (!task) return;
            
            currentEditId = id;
            document.getElementById('modalTitle').textContent = 'Edit Task';
            
            document.getElementById('taskDepartment').value = task.department;
            document.getElementById('taskStatus').value = task.status;
            document.getElementById('taskRemarks').value = task.remarks || '';
            document.getElementById('taskFrom').value = task.from || '';
            document.getElementById('taskTo').value = task.to || '';
            document.getElementById('taskStartDate').value = task.startDate;
            document.getElementById('taskDeliveryDate').value = task.deliveryDate || '';
            document.getElementById('taskPriority').value = task.priority || 'auto';
            document.getElementById('taskProgress').value = task.progressDetails || '';
            document.getElementById('taskProgressDate').value = task.progressDate || '';
            document.getElementById('taskPendingWith').value = task.pendingWith || '';
            document.getElementById('taskNextStep').value = task.nextStep || '';
            
            document.getElementById('taskModal').classList.add('show');
        }

        function deleteTask(id) {
            if (!checkPermission('delete')) return;
            
            if (confirm('Are you sure you want to delete this task?')) {
                tasks = tasks.filter(t => t.id !== id);
                filterTasks();
                updateStats();
                showStatusMessage('Task deleted successfully!');
            }
        }

        function saveTask() {
            const isEditing = currentEditId !== null;
            const requiredPermission = isEditing ? 'edit' : 'add';
            
            if (!checkPermission(requiredPermission)) return;
            
            const formData = {
                department: document.getElementById('taskDepartment').value.trim(),
                status: document.getElementById('taskStatus').value.trim(),
                remarks: document.getElementById('taskRemarks').value.trim(),
                from: document.getElementById('taskFrom').value.trim(),
                to: document.getElementById('taskTo').value.trim(),
                startDate: document.getElementById('taskStartDate').value,
                deliveryDate: document.getElementById('taskDeliveryDate').value,
                priority: document.getElementById('taskPriority').value,
                progressDetails: document.getElementById('taskProgress').value.trim(),
                progressDate: document.getElementById('taskProgressDate').value,
                pendingWith: document.getElementById('taskPendingWith').value.trim(),
                nextStep: document.getElementById('taskNextStep').value.trim()
            };
            
            // Validation
            if (!formData.department || !formData.status || !formData.startDate) {
                showStatusMessage('Please fill in all required fields (Department, Status, Start Date)', 'error');
                return;
            }
            
            try {
                if (currentEditId) {
                    // Edit existing task
                    const taskIndex = tasks.findIndex(t => t.id === currentEditId);
                    if (taskIndex === -1) {
                        showStatusMessage('Task not found for editing', 'error');
                        return;
                    }
                    tasks[taskIndex] = { ...tasks[taskIndex], ...formData };
                    showStatusMessage('Task updated successfully!');
                } else {
                    // Add new task
                    const newTask = {
                        ...formData,
                        id: Math.max(...tasks.map(t => t.id), 0) + 1
                    };
                    tasks.push(newTask);
                    showStatusMessage('Task added successfully!');
                }
                
                hideModal();
                filterTasks();
                updateStats();
                
            } catch (error) {
                console.error('Error saving task:', error);
                showStatusMessage('Error saving task. Please try again.', 'error');
            }
        }

        function hideModal() {
            document.getElementById('taskModal').classList.remove('show');
            clearForm();
        }

        function clearForm() {
            document.getElementById('taskDepartment').value = '';
            document.getElementById('taskStatus').value = '';
            document.getElementById('taskRemarks').value = '';
            document.getElementById('taskFrom').value = '';
            document.getElementById('taskTo').value = '';
            document.getElementById('taskStartDate').value = '';
            document.getElementById('taskDeliveryDate').value = '';
            document.getElementById('taskPriority').value = 'auto';
            document.getElementById('taskProgress').value = '';
            document.getElementById('taskProgressDate').value = '';
            document.getElementById('taskPendingWith').value = '';
            document.getElementById('taskNextStep').value = '';
        }

        // Event Listeners
        
        // Close settings menu when clicking outside
        document.addEventListener('click', function(e) {
            const dropdown = document.querySelector('.settings-dropdown');
            if (!dropdown.contains(e.target)) {
                hideSettingsMenu();
            }
        });

        // Close modals when clicking outside
        document.getElementById('taskModal').addEventListener('click', function(e) {
            if (e.target === this) {
                hideModal();
            }
        });

        document.getElementById('changePasswordModal').addEventListener('click', function(e) {
            if (e.target === this) {
                hideChangePasswordModal();
            }
        });

        document.getElementById('meetingModal').addEventListener('click', function(e) {
            if (e.target === this) {
                hideMeetingModal();
            }
        });

        // Allow Enter key to login
        document.getElementById('loginPassword').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                login();
            }
        });

        // Initialize application
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Application initialized');
            // Start with login screen
            document.getElementById('loginOverlay').style.display = 'flex';
        });
    </script>
</body>
</html>

    <script>
        // ====================== FIREBASE CONFIGURATION ======================
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            databaseURL: "https://YOUR_PROJECT_ID.firebaseio.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT_ID.appspot.com",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID",
            measurementId: "YOUR_MEASUREMENT_ID"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        const storage = firebase.storage();

        // Initialize EmailJS (for email reports)
        emailjs.init("YOUR_EMAILJS_USER_ID");

        // ====================== USER SYNCHRONIZATION ======================
        class UserSync {
            constructor() {
                this.currentUser = null;
                this.userData = {};
                this.authStateListeners = [];
                
                auth.onAuthStateChanged((user) => {
                    this.currentUser = user;
                    if (user) {
                        this.setupUserDataSync();
                        this.loadTasks();
                        this.loadMeetings();
                    }
                    this.notifyAuthStateChange();
                });
            }

            setupUserDataSync() {
                this.userDataUnsubscribe = db.collection('users')
                    .doc(this.currentUser.uid)
                    .onSnapshot((doc) => {
                        this.userData = doc.exists ? doc.data() : {};
                        this.notifyUserDataChange();
                    });
            }

            async loadTasks() {
                try {
                    const snapshot = await db.collection('tasks')
                        .where('userId', '==', this.currentUser.uid)
                        .get();
                    
                    tasks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderTasks();
                    updateStats();
                } catch (error) {
                    console.error("Error loading tasks:", error);
                    showStatusMessage("Error loading tasks. Please refresh.", 'error');
                }
            }

            async loadMeetings() {
                try {
                    const snapshot = await db.collection('meetings')
                        .where('userId', '==', this.currentUser.uid)
                        .get();
                    
                    meetings = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderMeetings();
                } catch (error) {
                    console.error("Error loading meetings:", error);
                    showStatusMessage("Error loading meetings. Please refresh.", 'error');
                }
            }

            onAuthStateChanged(callback) {
                this.authStateListeners.push(callback);
                if (this.currentUser !== null) {
                    callback(this.currentUser);
                }
            }

            notifyAuthStateChange() {
                this.authStateListeners.forEach(callback => callback(this.currentUser));
            }

            notifyUserDataChange() {
                // Implement any data change listeners here
            }

            async updateUserData(data) {
                try {
                    await db.collection('users')
                        .doc(this.currentUser.uid)
                        .set(data, { merge: true });
                    return true;
                } catch (error) {
                    console.error("Error updating user data:", error);
                    return false;
                }
            }
        }

        const userSync = new UserSync();

        // ====================== REPORT GENERATION ======================
        class ReportGenerator {
            constructor() {
                this.docx = window.docx;
                this.xlsx = window.XLSX;
                this.emailjs = window.emailjs;
            }

            async generateWordReport(data, reportType = 'tasks', fileName = `report-${Date.now()}.docx`) {
                try {
                    const { Document, Paragraph, TextRun, HeadingLevel, Packer } = this.docx;
                    
                    const doc = new Document({
                        sections: [{
                            properties: {},
                            children: [
                                new Paragraph({
                                    text: "Sikkim INSPIRES Programme Report",
                                    heading: HeadingLevel.HEADING_1,
                                    spacing: { after: 200 }
                                }),
                                new Paragraph({
                                    text: `Generated on: ${new Date().toLocaleString()}`,
                                    spacing: { after: 400 }
                                }),
                                // Add report content based on type
                                ...this.getReportContent(data, reportType)
                            ]
                        }]
                    });
                    
                    const blob = await Packer.toBlob(doc);
                    this.downloadBlob(blob, fileName);
                    return true;
                } catch (error) {
                    console.error("Word report generation failed:", error);
                    showStatusMessage("Failed to generate Word report", 'error');
                    return false;
                }
            }

            getReportContent(data, reportType) {
                if (reportType === 'tasks') {
                    return [
                        new Paragraph({
                            text: "Tasks Report",
                            heading: HeadingLevel.HEADING_2
                        }),
                        ...data.map(task => new Paragraph({
                            children: [
                                new TextRun({
                                    text: `${task.department}: ${task.status}`,
                                    bold: true
                                }),
                                new TextRun({
                                    text: `\nDelivery Date: ${task.deliveryDate || 'N/A'}`,
                                    break: 1
                                }),
                                new TextRun({
                                    text: `\nPriority: ${this.getPriorityDisplay(task)}`,
                                    break: 1
                                }),
                                new TextRun({
                                    text: `\nProgress: ${task.progressDetails || 'No progress updates'}`,
                                    break: 1
                                })
                            ],
                            spacing: { after: 200 }
                        }))
                    ];
                } else {
                    // Meetings report
                    return [
                        new Paragraph({
                            text: "Meetings Report",
                            heading: HeadingLevel.HEADING_2
                        }),
                        ...data.map(meeting => new Paragraph({
                            children: [
                                new TextRun({
                                    text: meeting.title,
                                    bold: true
                                }),
                                new TextRun({
                                    text: `\nDate: ${new Date(meeting.date).toLocaleString()}`,
                                    break: 1
                                }),
                                new TextRun({
                                    text: `\nObjective: ${meeting.objective}`,
                                    break: 1
                                }),
                                new TextRun({
                                    text: `\nKey Decisions: ${meeting.decisions || 'None recorded'}`,
                                    break: 1
                                })
                            ],
                            spacing: { after: 200 }
                        }))
                    ];
                }
            }

            getPriorityDisplay(task) {
                const priority = this.getTaskPriority(task);
                return task.priority === 'auto' ? 
                    `${priority.charAt(0).toUpperCase() + priority.slice(1)} (Auto)` : 
                    priority.charAt(0).toUpperCase() + priority.slice(1);
            }

            async generateExcelReport(data, reportType = 'tasks', fileName = `report-${Date.now()}.xlsx`) {
                try {
                    let worksheet;
                    
                    if (reportType === 'tasks') {
                        const formattedData = data.map(task => ({
                            "Department": task.department,
                            "Status": task.status,
                            "Start Date": task.startDate,
                            "Delivery Date": task.deliveryDate || 'N/A',
                            "Priority": this.getPriorityDisplay(task),
                            "Progress": task.progressDetails || 'No progress',
                            "Pending With": task.pendingWith || 'N/A',
                            "Next Step": task.nextStep || 'N/A'
                        }));
                        
                        worksheet = this.xlsx.utils.json_to_sheet(formattedData);
                    } else {
                        // Meetings report
                        const formattedData = data.map(meeting => ({
                            "Title": meeting.title,
                            "Date": new Date(meeting.date).toLocaleString(),
                            "Departments": meeting.departments,
                            "Chairperson": meeting.chairperson,
                            "Objective": meeting.objective,
                            "Key Decisions": meeting.decisions || 'None',
                            "Action Items": meeting.actionItems || 'None'
                        }));
                        
                        worksheet = this.xlsx.utils.json_to_sheet(formattedData);
                    }
                    
                    const workbook = this.xlsx.utils.book_new();
                    this.xlsx.utils.book_append_sheet(workbook, worksheet, "Report");
                    this.xlsx.writeFile(workbook, fileName);
                    
                    return true;
                } catch (error) {
                    console.error("Excel report generation failed:", error);
                    showStatusMessage("Failed to generate Excel report", 'error');
                    return false;
                }
            }

            async sendEmailReport(data, reportType, recipientEmail, subject = "Sikkim INSPIRES Report") {
                try {
                    // First generate the reports
                    const wordReport = await this.generateWordReport(data, reportType, `temp-report-${Date.now()}.docx`);
                    const excelReport = await this.generateExcelReport(data, reportType, `temp-report-${Date.now()}.xlsx`);
                    
                    if (!wordReport || !excelReport) {
                        throw new Error("Failed to generate reports");
                    }
                    
                    // Upload reports to Firebase Storage
                    const wordRef = storage.ref(`reports/${currentUser.uid}/word-report-${Date.now()}.docx`);
                    const excelRef = storage.ref(`reports/${currentUser.uid}/excel-report-${Date.now()}.xlsx`);
                    
                    await wordRef.put(wordReport);
                    await excelRef.put(excelReport);
                    
                    // Get download URLs
                    const wordUrl = await wordRef.getDownloadURL();
                    const excelUrl = await excelRef.getDownloadURL();
                    
                    // Send email with links to the reports
                    const emailParams = {
                        to_email: recipientEmail,
                        from_name: "Sikkim INSPIRES Tracker",
                        subject: subject,
                        message: `Please find attached the ${reportType} report from Sikkim INSPIRES Programme Tracker.`,
                        word_report_url: wordUrl,
                        excel_report_url: excelUrl
                    };
                    
                    await this.emailjs.send('YOUR_EMAILJS_SERVICE_ID', 'YOUR_EMAILJS_TEMPLATE_ID', emailParams);
                    
                    showStatusMessage("Report sent by email successfully!");
                    return true;
                } catch (error) {
                    console.error("Error sending email report:", error);
                    showStatusMessage("Failed to send email report", 'error');
                    return false;
                }
            }

            downloadBlob(blob, fileName) {
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.href = url;
                link.download = fileName;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            }
        }

        const reportGenerator = new ReportGenerator();

        // ====================== DEBUGGING UTILITIES ======================
        class DebugUtils {
            static logFirestoreData(collectionName) {
                return db.collection(collectionName)
                    .get()
                    .then(snapshot => {
                        const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        console.log(`${collectionName} data:`, data);
                        return data;
                    });
            }

            static showDataDebugInfo() {
                const debugContainer = document.createElement('div');
                debugContainer.className = 'debug-info';
                debugContainer.innerHTML = `
                    <h3>Debug Information</h3>
                    <p><strong>Current User:</strong> ${currentUser.username || 'Not logged in'}</p>
                    <p><strong>Tasks Count:</strong> ${tasks.length}</p>
                    <p><strong>Meetings Count:</strong> ${meetings.length}</p>
                    <p><strong>Last Sync:</strong> ${new Date().toLocaleString()}</p>
                `;
                
                document.body.appendChild(debugContainer);
                setTimeout(() => {
                    document.body.removeChild(debugContainer);
                }, 10000);
            }

            static logStorageUsage() {
                return storage.ref().listAll()
                    .then(res => {
                        let totalSize = 0;
                        res.items.forEach(itemRef => {
                            itemRef.getMetadata().then(metadata => {
                                totalSize += metadata.size;
                            });
                        });
                        console.log(`Storage usage: ${(totalSize / (1024 * 1024)).toFixed(2)} MB`);
                        return totalSize;
                    });
            }
        }

        // ====================== TASK INTEGRATION ======================
        // Modify task functions to use Firestore
        
        async function saveTask() {
            const isEditing = currentEditId !== null;
            const requiredPermission = isEditing ? 'edit' : 'add';
            
            if (!checkPermission(requiredPermission)) return;
            
            const formData = {
                department: document.getElementById('taskDepartment').value.trim(),
                status: document.getElementById('taskStatus').value.trim(),
                remarks: document.getElementById('taskRemarks').value.trim(),
                from: document.getElementById('taskFrom').value.trim(),
                to: document.getElementById('taskTo').value.trim(),
                startDate: document.getElementById('taskStartDate').value,
                deliveryDate: document.getElementById('taskDeliveryDate').value,
                priority: document.getElementById('taskPriority').value,
                progressDetails: document.getElementById('taskProgress').value.trim(),
                progressDate: document.getElementById('taskProgressDate').value,
                pendingWith: document.getElementById('taskPendingWith').value.trim(),
                nextStep: document.getElementById('taskNextStep').value.trim(),
                userId: userSync.currentUser.uid,
                lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            // Validation
            if (!formData.department || !formData.status || !formData.startDate) {
                showStatusMessage('Please fill in all required fields (Department, Status, Start Date)', 'error');
                return;
            }
            
            try {
                if (currentEditId) {
                    // Edit existing task
                    await db.collection('tasks').doc(currentEditId).update(formData);
                    showStatusMessage('Task updated successfully!');
                } else {
                    // Add new task
                    await db.collection('tasks').add(formData);
                    showStatusMessage('Task added successfully!');
                }
                
                hideModal();
                // No need to manually update tasks array - the snapshot listener will handle it
                
            } catch (error) {
                console.error('Error saving task:', error);
                showStatusMessage('Error saving task. Please try again.', 'error');
            }
        }

        async function deleteTask(id) {
            if (!checkPermission('delete')) return;
            
            if (confirm('Are you sure you want to delete this task?')) {
                try {
                    await db.collection('tasks').doc(id).delete();
                    showStatusMessage('Task deleted successfully!');
                } catch (error) {
                    console.error("Error deleting task:", error);
                    showStatusMessage("Failed to delete task", 'error');
                }
            }
        }

        // ====================== MEETING INTEGRATION ======================
        // Modify meeting functions to use Firestore
        
        async function saveMeeting() {
            const isEditing = currentEditMeetingId !== null;
            const requiredPermission = isEditing ? 'edit' : 'add';
            
            if (!checkPermission(requiredPermission)) return;
            
            const formData = {
                title: document.getElementById('meetingTitle').value.trim(),
                date: document.getElementById('meetingDate').value,
                departments: document.getElementById('meetingDepartments').value.trim(),
                chairperson: document.getElementById('meetingChairperson').value.trim(),
                attendees: document.getElementById('meetingAttendees').value.trim(),
                objective: document.getElementById('meetingObjective').value.trim(),
                discussion: document.getElementById('meetingDiscussion').value.trim(),
                decisions: document.getElementById('meetingDecisions').value.trim(),
                actionItems: document.getElementById('meetingActionItems').value.trim(),
                nextSteps: document.getElementById('meetingNextSteps').value.trim(),
                userId: userSync.currentUser.uid,
                lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            // Validation
            if (!formData.title || !formData.date || !formData.attendees || !formData.objective) {
                showStatusMessage('Please fill in all required fields (Title, Date, Attendees, Objective)', 'error');
                return;
            }
            
            try {
                if (currentEditMeetingId) {
                    // Edit existing meeting
                    await db.collection('meetings').doc(currentEditMeetingId).update(formData);
                    showStatusMessage('Meeting updated successfully!');
                } else {
                    // Add new meeting
                    await db.collection('meetings').add(formData);
                    showStatusMessage('Meeting added successfully!');
                }
                
                hideMeetingModal();
                // No need to manually update meetings array - the snapshot listener will handle it
                
            } catch (error) {
                console.error('Error saving meeting:', error);
                showStatusMessage('Error saving meeting. Please try again.', 'error');
            }
        }

        async function deleteMeeting(id) {
            if (!checkPermission('delete')) return;
            
            if (confirm('Are you sure you want to delete this meeting record?')) {
                try {
                    await db.collection('meetings').doc(id).delete();
                    showStatusMessage('Meeting deleted successfully!');
                } catch (error) {
                    console.error("Error deleting meeting:", error);
                    showStatusMessage("Failed to delete meeting", 'error');
                }
            }
        }

        // ====================== AUTHENTICATION INTEGRATION ======================
        async function login() {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            if (!username || !password) {
                showError('loginError', 'Please enter both username and password');
                return;
            }
            
            try {
                // Use Firebase Authentication
                const userCredential = await auth.signInWithEmailAndPassword(
                    `${username}@sikkiminspires.in`, // Using a domain pattern for emails
                    password
                );
                
                const user = userCredential.user;
                
                // Get user role from Firestore
                const userDoc = await db.collection('users').doc(user.uid).get();
                if (!userDoc.exists) {
                    throw new Error("User not found in database");
                }
                
                const userData = userDoc.data();
                
                // Update current user
                currentUser.username = username;
                currentUser.uid = user.uid;
                currentUser.role = userData.role;
                currentUser.name = userData.name || username;
                currentUser.permissions = roleConfig[userData.role].permissions;
                
                // Update UI
                updateUserInterface();
                
                // Hide login overlay
                document.getElementById('loginOverlay').style.display = 'none';
                
                // Initialize the app
                initializeApp();
                
                showStatusMessage(`Welcome, ${currentUser.name}! You are logged in as ${roleConfig[currentUser.role].name}.`);
                
            } catch (error) {
                console.error("Login error:", error);
                showError('loginError', 'Invalid username or password');
            }
        }

        async function logout() {
            if (confirm('Are you sure you want to logout?')) {
                try {
                    await auth.signOut();
                    currentUser = { username: null, role: null, name: '', permissions: {} };
                    
                    // Reset login form
                    document.getElementById('loginUsername').value = '';
                    document.getElementById('loginPassword').value = '';
                    hideError('loginError');
                    
                    // Hide settings menu
                    hideSettingsMenu();
                    
                    // Show login overlay
                    document.getElementById('loginOverlay').style.display = 'flex';
                    
                } catch (error) {
                    console.error("Logout error:", error);
                    showStatusMessage("Error during logout", 'error');
                }
            }
        }

        async function changePassword() {
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            // Validate new password
            const validation = validatePassword(newPassword);
            if (!validation.valid) {
                showError('passwordError', validation.message);
                return;
            }
            
            // Check password confirmation
            if (newPassword !== confirmPassword) {
                showError('passwordError', 'New passwords do not match');
                return;
            }
            
            try {
                // Reauthenticate user
                const credential = firebase.auth.EmailAuthProvider.credential(
                    `${currentUser.username}@sikkiminspires.in`,
                    currentPassword
                );
                
                await auth.currentUser.reauthenticateWithCredential(credential);
                
                // Update password
                await auth.currentUser.updatePassword(newPassword);
                
                showSuccess('passwordSuccess', 'Password changed successfully!');
                
                // Clear form after 2 seconds and close modal
                setTimeout(() => {
                    hideChangePasswordModal();
                }, 2000);
                
            } catch (error) {
                console.error("Password change error:", error);
                showError('passwordError', error.message || 'Failed to change password');
            }
        }

        // ====================== REPORT GENERATION UI ======================
        // Add these functions to your existing code
        function showReportGenerationModal() {
            const modalContent = `
                <h2>Generate Report</h2>
                <div class="form-group">
                    <label for="reportType">Report Type</label>
                    <select id="reportType">
                        <option value="tasks">Tasks Report</option>
                        <option value="meetings">Meetings Report</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="reportFormat">Format</label>
                    <select id="reportFormat">
                        <option value="word">Word Document</option>
                        <option value="excel">Excel Spreadsheet</option>
                        <option value="both">Both Formats</option>
                        <option value="email">Email Report</option>
                    </select>
                </div>
                <div class="form-group" id="emailFieldGroup" style="display: none;">
                    <label for="recipientEmail">Recipient Email</label>
                    <input type="email" id="recipientEmail" placeholder="Enter recipient email">
                </div>
                <div class="btn-group">
                    <button class="btn" onclick="generateReport()">Generate</button>
                    <button class="btn btn-secondary" onclick="hideReportModal()">Cancel</button>
                </div>
            `;
            
            // Create or update modal
            let modal = document.getElementById('reportModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'reportModal';
                modal.className = 'modal';
                modal.innerHTML = `<div class="modal-content">${modalContent}</div>`;
                document.body.appendChild(modal);
            } else {
                modal.querySelector('.modal-content').innerHTML = modalContent;
            }
            
            // Show email field when email option is selected
            document.getElementById('reportFormat').addEventListener('change', function() {
                document.getElementById('emailFieldGroup').style.display = 
                    this.value === 'email' ? 'block' : 'none';
            });
            
            modal.classList.add('show');
        }

        function hideReportModal() {
            document.getElementById('reportModal').classList.remove('show');
        }

        async function generateReport() {
            const reportType = document.getElementById('reportType').value;
            const format = document.getElementById('reportFormat').value;
            const recipientEmail = document.getElementById('recipientEmail')?.value;
            
            const data = reportType === 'tasks' ? tasks : meetings;
            
            try {
                showStatusMessage(`Generating ${reportType} report...`);
                
                if (format === 'word' || format === 'both') {
                    await reportGenerator.generateWordReport(data, reportType);
                }
                
                if (format === 'excel' || format === 'both') {
                    await reportGenerator.generateExcelReport(data, reportType);
                }
                
                if (format === 'email') {
                    if (!recipientEmail) {
                        showStatusMessage('Please enter recipient email', 'error');
                        return;
                    }
                    await reportGenerator.sendEmailReport(data, reportType, recipientEmail);
                }
                
                hideReportModal();
                showStatusMessage('Report generated successfully!');
                
            } catch (error) {
                console.error("Report generation error:", error);
                showStatusMessage('Failed to generate report', 'error');
            }
        }

        // Add report generation button to your UI (in header or settings menu)
        function addReportButton() {
            const header = document.querySelector('.header-content');
            if (!header) return;
            
            const reportBtn = document.createElement('button');
            reportBtn.className = 'btn';
            reportBtn.innerHTML = '📊 Generate Report';
            reportBtn.onclick = showReportGenerationModal;
            
            header.appendChild(reportBtn);
        }

        // ====================== DEBUGGING TOOLS ======================
        // Add debugging tools to your UI
        function addDebugTools() {
            const debugBtn = document.createElement('button');
            debugBtn.className = 'btn btn-secondary';
            debugBtn.innerHTML = '🐛 Debug';
            debugBtn.style.position = 'fixed';
            debugBtn.style.bottom = '20px';
            debugBtn.style.right = '20px';
            debugBtn.style.zIndex = '1000';
            debugBtn.onclick = function() {
                DebugUtils.showDataDebugInfo();
                DebugUtils.logStorageUsage();
                DebugUtils.logFirestoreData('tasks');
                DebugUtils.logFirestoreData('meetings');
            };
            
            document.body.appendChild(debugBtn);
        }

        // ====================== INITIALIZATION ======================
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Application initialized');
            
            // Start with login screen
            document.getElementById('loginOverlay').style.display = 'flex';
            
            // Add report generation button if user has permission
            if (hasPermission('view')) {
                addReportButton();
                addDebugTools();
            }
            
            // Initialize debug info
            DebugUtils.showDataDebugInfo();
        });

        // ====================== TASK INTEGRATION (34 TASKS) ======================
        // Here's how to integrate all 34 tasks - we'll modify the task management functions
        // to handle the specific requirements of the Sikkim INSPIRES programme

        // 1. First, define the 34 tasks with their metadata
        const predefinedTasks = [
            {
                id: 1,
                department: "C&ID",
                defaultStatus: "Convergence discussion between EEPF and Innovation Hub completed and TSA has shared the Scope of Work for Lead Incubation Partner with PMU for review.",
                defaultRemarks: "With PMU",
                from: "PMU",
                to: "C&ID",
                startDate: "2025-08-06",
                deliveryDate: "2025-08-20",
                priority: "high",
                category: "Innovation Hub"
            },
            // Add the remaining 33 tasks with their specific details
            // Each task should have department, default status, from/to, dates, etc.
            // ...
            
            {
                id: 34,
                department: "WCDD",
                defaultStatus: "Finalizing the selection of training providers for women entrepreneurship programs.",
                defaultRemarks: "Under evaluation",
                from: "PMU",
                to: "WCDD",
                startDate: "2025-08-10",
                deliveryDate: "2025-09-15",
                priority: "medium",
                category: "Women Entrepreneurship"
            }
        ];

        // 2. Add function to load predefined tasks
        function loadPredefinedTasks() {
            if (!checkPermission('add')) return;
            
            const modalContent = `
                <h2>Load Predefined Tasks</h2>
                <p>Select which predefined tasks to add to your tracker:</p>
                <div style="max-height: 400px; overflow-y: auto;">
                    ${predefinedTasks.map(task => `
                        <div style="margin-bottom: 10px; padding: 10px; border: 1px solid #e5e7eb; border-radius: 5px;">
                            <input type="checkbox" id="task-${task.id}" checked>
                            <label for="task-${task.id}">
                                <strong>${task.department}</strong>: ${task.defaultStatus.substring(0, 50)}...
                            </label>
                        </div>
                    `).join('')}
                </div>
                <div class="btn-group" style="margin-top: 20px;">
                    <button class="btn" onclick="addSelectedPredefinedTasks()">Add Selected Tasks</button>
                    <button class="btn btn-secondary" onclick="hidePredefinedTasksModal()">Cancel</button>
                </div>
            `;
            
            let modal = document.getElementById('predefinedTasksModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'predefinedTasksModal';
                modal.className = 'modal';
                modal.innerHTML = `<div class="modal-content">${modalContent}</div>`;
                document.body.appendChild(modal);
            } else {
                modal.querySelector('.modal-content').innerHTML = modalContent;
            }
            
            modal.classList.add('show');
        }

        async function addSelectedPredefinedTasks() {
            const checkboxes = document.querySelectorAll('#predefinedTasksModal input[type="checkbox"]:checked');
            
            if (checkboxes.length === 0) {
                showStatusMessage('No tasks selected', 'error');
                return;
            }
            
            try {
                showStatusMessage(`Adding ${checkboxes.length} tasks...`);
                
                const batch = db.batch();
                const tasksRef = db.collection('tasks');
                
                checkboxes.forEach(checkbox => {
                    const taskId = checkbox.id.split('-')[1];
                    const task = predefinedTasks.find(t => t.id == taskId);
                    
                    if (task) {
                        const newTaskRef = tasksRef.doc();
                        batch.set(newTaskRef, {
                            ...task,
                            status: task.defaultStatus,
                            remarks: task.defaultRemarks,
                            userId: userSync.currentUser.uid,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    }
                });
                
                await batch.commit();
                showStatusMessage(`${checkboxes.length} tasks added successfully!`);
                hidePredefinedTasksModal();
                
            } catch (error) {
                console.error("Error adding predefined tasks:", error);
                showStatusMessage("Failed to add tasks", 'error');
            }
        }

        function hidePredefinedTasksModal() {
            document.getElementById('predefinedTasksModal').classList.remove('show');
        }

        // 3. Add button to load predefined tasks
        function addPredefinedTasksButton() {
            const header = document.querySelector('.header-content');
            if (!header) return;
            
            const loadTasksBtn = document.createElement('button');
            loadTasksBtn.className = 'btn btn-secondary';
            loadTasksBtn.innerHTML = '📋 Load Predefined Tasks';
            loadTasksBtn.onclick = loadPredefinedTasks;
            
            header.appendChild(loadTasksBtn);
        }

        // Initialize the predefined tasks button
        if (hasPermission('add')) {
            addPredefinedTasksButton();
        }

        // ====================== CATEGORY FILTERS ======================
        // Add category filtering for the 34 tasks
        function addCategoryFilter() {
            const filters = document.querySelector('.filters-grid');
            if (!filters) return;
            
            const categoryFilter = document.createElement('select');
            categoryFilter.id = 'categoryFilter';
            categoryFilter.onchange = filterTasks;
            
            // Get unique categories from predefined tasks
            const categories = [...new Set(predefinedTasks.map(task => task.category))];
            
            categoryFilter.innerHTML = `
                <option value="all">All Categories</option>
                ${categories.map(cat => `<option value="${cat}">${cat}</option>`).join('')}
            `;
            
            filters.appendChild(categoryFilter);
        }

        // Modify filterTasks to include category filter
        function filterTasks() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const departmentFilter = document.getElementById('departmentFilter').value;
            const priorityFilter = document.getElementById('priorityFilter').value;
            const categoryFilter = document.getElementById('categoryFilter')?.value || 'all';
            const sortBy = document.getElementById('sortBy').value;
            
            let filtered = tasks.filter(task => {
                const matchesSearch = task.status.toLowerCase().includes(searchTerm) ||
                                   task.department.toLowerCase().includes(searchTerm) ||
                                   (task.remarks && task.remarks.toLowerCase().includes(searchTerm)) ||
                                   (task.pendingWith && task.pendingWith.toLowerCase().includes(searchTerm));
                const matchesDepartment = departmentFilter === 'all' || task.department === departmentFilter;
                const matchesPriority = priorityFilter === 'all' || getTaskPriority(task) === priorityFilter;
                const matchesCategory = categoryFilter === 'all' || 
                                      (task.category && task.category === categoryFilter);
                
                return matchesSearch && matchesDepartment && matchesPriority && matchesCategory;
            });

            // Sort
            filtered.sort((a, b) => {
                if (sortBy === 'deliveryDate') {
                    if (!a.deliveryDate && !b.deliveryDate) return 0;
                    if (!a.deliveryDate) return 1;
                    if (!b.deliveryDate) return -1;
                    return new Date(a.deliveryDate) - new Date(b.deliveryDate);
                }
                if (sortBy === 'department') {
                    return a.department.localeCompare(b.department);
                }
                return a.id - b.id;
            });

            renderTasks(filtered);
        }

        // Initialize category filter
        addCategoryFilter();

        // ====================== TASK TEMPLATES ======================
        // Add function to save task as template
        async function saveTaskAsTemplate() {
            if (!checkPermission('add')) return;
            
            const taskData = {
                department: document.getElementById('taskDepartment').value.trim(),
                status: document.getElementById('taskStatus').value.trim(),
                remarks: document.getElementById('taskRemarks').value.trim(),
                from: document.getElementById('taskFrom').value.trim(),
                to: document.getElementById('taskTo').value.trim(),
                priority: document.getElementById('taskPriority').value,
                category: prompt("Enter a category name for this template:"),
                userId: userSync.currentUser.uid,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            if (!taskData.category) return;
            
            try {
                await db.collection('taskTemplates').add(taskData);
                showStatusMessage('Task template saved successfully!');
            } catch (error) {
                console.error("Error saving task template:", error);
                showStatusMessage("Failed to save template", 'error');
            }
        }

        // Add button to save as template in task modal
        function addTemplateButtonToModal() {
            const btnGroup = document.querySelector('#taskModal .btn-group');
            if (!btnGroup) return;
            
            const templateBtn = document.createElement('button');
            templateBtn.className = 'btn btn-secondary';
            templateBtn.textContent = '💾 Save as Template';
            templateBtn.onclick = saveTaskAsTemplate;
            
            btnGroup.insertBefore(templateBtn, btnGroup.firstChild);
        }

        // Initialize template button
        addTemplateButtonToModal();

        // ====================== TASK DEPENDENCIES ======================
        // Add function to set task dependencies
        async function setTaskDependencies(taskId) {
            if (!checkPermission('edit')) return;
            
            // Get all other tasks for dropdown
            const otherTasks = tasks.filter(task => task.id !== taskId);
            
            const modalContent = `
                <h2>Set Task Dependencies</h2>
                <p>Select which tasks must be completed before this one:</p>
                <div style="max-height: 300px; overflow-y: auto;">
                    ${otherTasks.map(task => `
                        <div style="margin-bottom: 5px;">
                            <input type="checkbox" id="dep-${task.id}" 
                                   ${task.dependencies && task.dependencies.includes(taskId) ? 'checked' : ''}>
                            <label for="dep-${task.id}">
                                ${task.department}: ${task.status.substring(0, 50)}...
                            </label>
                        </div>
                    `).join('')}
                </div>
                <div class="btn-group" style="margin-top: 20px;">
                    <button class="btn" onclick="saveTaskDependencies('${taskId}')">Save Dependencies</button>
                    <button class="btn btn-secondary" onclick="hideDependenciesModal()">Cancel</button>
                </div>
            `;
            
            let modal = document.getElementById('dependenciesModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'dependenciesModal';
                modal.className = 'modal';
                modal.innerHTML = `<div class="modal-content">${modalContent}</div>`;
                document.body.appendChild(modal);
            } else {
                modal.querySelector('.modal-content').innerHTML = modalContent;
            }
            
            modal.classList.add('show');
        }

        async function saveTaskDependencies(taskId) {
            const checkboxes = document.querySelectorAll('#dependenciesModal input[type="checkbox"]:checked');
            const dependencies = Array.from(checkboxes).map(cb => cb.id.split('-')[1]);
            
            try {
                await db.collection('tasks').doc(taskId).update({
                    dependencies,
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                });
                showStatusMessage('Dependencies updated successfully!');
                hideDependenciesModal();
            } catch (error) {
                console.error("Error updating dependencies:", error);
                showStatusMessage("Failed to update dependencies", 'error');
            }
        }

        function hideDependenciesModal() {
            document.getElementById('dependenciesModal').classList.remove('show');
        }

        // Add dependencies button to task row
        function addDependenciesButtonToTask(taskId) {
            return `<button class="btn btn-sm" onclick="setTaskDependencies('${taskId}')">🔗</button>`;
        }

        // Modify renderTasks to include dependencies button
        // (Add this button to the actions column if user has edit permission)

        // ====================== TASK HISTORY ======================
        // Add function to view task history
        async function viewTaskHistory(taskId) {
            try {
                const historySnap = await db.collection('taskHistory')
                    .where('taskId', '==', taskId)
                    .orderBy('timestamp', 'desc')
                    .get();
                
                const history = historySnap.docs.map(doc => doc.data());
                
                const modalContent = `
                    <h2>Task History</h2>
                    <div style="max-height: 400px; overflow-y: auto;">
                        ${history.length > 0 ? 
                            history.map(entry => `
                                <div style="margin-bottom: 15px; padding: 10px; border-bottom: 1px solid #e5e7eb;">
                                    <div><strong>${new Date(entry.timestamp?.toDate()).toLocaleString()}</strong></div>
                                    <div>Changed by: ${entry.changedBy || 'System'}</div>
                                    <div style="margin-top: 5px;">
                                        ${Object.entries(entry.changes).map(([field, values]) => `
                                            <div>
                                                <span style="font-weight: 500;">${field}:</span>
                                                <span style="color: #dc2626; text-decoration: line-through;">${values.old || 'N/A'}</span>
                                                <span style="color: #16a34a;">→ ${values.new || 'N/A'}</span>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            `).join('') :
                            '<p>No history available for this task</p>'
                        }
                    </div>
                    <div class="btn-group" style="margin-top: 20px;">
                        <button class="btn btn-secondary" onclick="hideHistoryModal()">Close</button>
                    </div>
                `;
                
                let modal = document.getElementById('historyModal');
                if (!modal) {
                    modal = document.createElement('div');
                    modal.id = 'historyModal';
                    modal.className = 'modal';
                    modal.innerHTML = `<div class="modal-content">${modalContent}</div>`;
                    document.body.appendChild(modal);
                } else {
                    modal.querySelector('.modal-content').innerHTML = modalContent;
                }
                
                modal.classList.add('show');
                
            } catch (error) {
                console.error("Error fetching task history:", error);
                showStatusMessage("Failed to load task history", 'error');
            }
        }

        function hideHistoryModal() {
            document.getElementById('historyModal').classList.remove('show');
        }

        // Add history button to task row
        function addHistoryButtonToTask(taskId) {
            return `<button class="btn btn-sm" onclick="viewTaskHistory('${taskId}')">🕒</button>`;
        }

        // ====================== BULK ACTIONS ======================
        // Add function for bulk task updates
        function showBulkActionsModal() {
            if (!checkPermission('edit')) return;
            
            const modalContent = `
                <h2>Bulk Task Actions</h2>
                <div class="form-group">
                    <label for="bulkAction">Action</label>
                    <select id="bulkAction">
                        <option value="status">Update Status</option>
                        <option value="priority">Update Priority</option>
                        <option value="department">Update Department</option>
                        <option value="progress">Update Progress</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="bulkValue">New Value</label>
                    <input type="text" id="bulkValue" placeholder="Enter new value">
                </div>
                <div class="form-group">
                    <label for="bulkRemarks">Remarks (optional)</label>
                    <input type="text" id="bulkRemarks" placeholder="Enter remarks">
                </div>
                <div class="btn-group">
                    <button class="btn" onclick="applyBulkAction()">Apply to Selected</button>
                    <button class="btn btn-secondary" onclick="hideBulkActionsModal()">Cancel</button>
                </div>
            `;
            
            let modal = document.getElementById('bulkActionsModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'bulkActionsModal';
                modal.className = 'modal';
                modal.innerHTML = `<div class="modal-content">${modalContent}</div>`;
                document.body.appendChild(modal);
            } else {
                modal.querySelector('.modal-content').innerHTML = modalContent;
            }
            
            modal.classList.add('show');
        }

        async function applyBulkAction() {
            const action = document.getElementById('bulkAction').value;
            const value = document.getElementById('bulkValue').value.trim();
            const remarks = document.getElementById('bulkRemarks').value.trim();
            
            if (!value) {
                showStatusMessage('Please enter a value for the action', 'error');
                return;
            }
            
            // Get selected tasks (you would need to add checkboxes to your task rows)
            const selectedTasks = Array.from(document.querySelectorAll('#tasksTableBody input[type="checkbox"]:checked'))
                .map(checkbox => checkbox.closest('tr').dataset.taskId);
            
            if (selectedTasks.length === 0) {
                showStatusMessage('No tasks selected', 'error');
                return;
            }
            
            try {
                showStatusMessage(`Updating ${selectedTasks.length} tasks...`);
                
                const batch = db.batch();
                const tasksRef = db.collection('tasks');
                
                selectedTasks.forEach(taskId => {
                    const updateData = {
                        lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                    };
                    
                    if (remarks) {
                        updateData.remarks = remarks;
                    }
                    
                    switch(action) {
                        case 'status':
                            updateData.status = value;
                            break;
                        case 'priority':
                            updateData.priority = value;
                            break;
                        case 'department':
                            updateData.department = value;
                            break;
                        case 'progress':
                            updateData.progressDetails = value;
                            updateData.progressDate = new Date().toISOString().split('T')[0];
                            break;
                    }
                    
                    batch.update(tasksRef.doc(taskId), updateData);
                });
                
                await batch.commit();
                showStatusMessage(`${selectedTasks.length} tasks updated successfully!`);
                hideBulkActionsModal();
                
            } catch (error) {
                console.error("Bulk update error:", error);
                showStatusMessage("Failed to update tasks", 'error');
            }
        }

        function hideBulkActionsModal() {
            document.getElementById('bulkActionsModal').classList.remove('show');
        }

        // Add bulk actions button to UI
        function addBulkActionsButton() {
            const header = document.querySelector('.header-content');
            if (!header) return;
            
            const bulkBtn = document.createElement('button');
            bulkBtn.className = 'btn btn-secondary';
            bulkBtn.innerHTML = '🧰 Bulk Actions';
            bulkBtn.onclick = showBulkActionsModal;
            
            header.appendChild(bulkBtn);
        }

        // Initialize bulk actions button
        if (hasPermission('edit')) {
            addBulkActionsButton();
        }

        // ====================== TASK NOTIFICATIONS ======================
        // Add function to notify about upcoming deadlines
        async function checkDeadlinesAndNotify() {
            if (!hasPermission('view')) return;
            
            const now = new Date();
            const threshold = new Date(now.getTime() + 3 * 24 * 60 * 60 * 1000); // 3 days from now
            
            try {
                const snapshot = await db.collection('tasks')
                    .where('userId', '==', userSync.currentUser.uid)
                    .where('deliveryDate', '>=', now.toISOString().split('T')[0])
                    .where('deliveryDate', '<=', threshold.toISOString().split('T')[0])
                    .get();
                
                const upcomingTasks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                if (upcomingTasks.length > 0) {
                    const taskList = upcomingTasks.map(task => 
                        `${task.department}: ${task.status.substring(0, 30)}... (Due: ${task.deliveryDate})`
                    ).join('\n');
                    
                    showStatusMessage(`You have ${upcomingTasks.length} tasks due in the next 3 days:\n${taskList}`);
                    
                    // Optionally send email notification
                    if (confirm('Would you like to receive an email reminder about these tasks?')) {
                        await reportGenerator.sendEmailReport(
                            upcomingTasks,
                            'tasks',
                            currentUser.username + '@sikkiminspires.in',
                            'Upcoming Task Deadlines'
                        );
                    }
                }
            } catch (error) {
                console.error("Error checking deadlines:", error);
            }
        }

        // Check deadlines periodically (every 6 hours)
        setInterval(checkDeadlinesAndNotify, 6 * 60 * 60 * 1000);
        // Also check on initial load
        if (userSync.currentUser) {
            checkDeadlinesAndNotify();
        }

        // ====================== TASK COMMENTS ======================
        // Add function to add comments to tasks
        async function addTaskComment(taskId) {
            const comment = prompt('Enter your comment:');
            if (!comment) return;
            
            try {
                await db.collection('taskComments').add({
                    taskId,
                    comment,
                    userId: userSync.currentUser.uid,
                    userName: currentUser.name,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                showStatusMessage('Comment added successfully!');
            } catch (error) {
                console.error("Error adding comment:", error);
                showStatusMessage("Failed to add comment", 'error');
            }
        }

        async function viewTaskComments(taskId) {
            try {
                const commentsSnap = await db.collection('taskComments')
                    .where('taskId', '==', taskId)
                    .orderBy('timestamp', 'desc')
                    .get();
                
                const comments = commentsSnap.docs.map(doc => doc.data());
                
                const modalContent = `
                    <h2>Task Comments</h2>
                    <div style="max-height: 300px; overflow-y: auto; margin-bottom: 15px;">
                        ${comments.length > 0 ? 
                            comments.map(comment => `
                                <div style="margin-bottom: 10px; padding: 10px; background: #f9fafb; border-radius: 5px;">
                                    <div style="font-weight: 500;">${comment.userName} - ${new Date(comment.timestamp?.toDate()).toLocaleString()}</div>
                                    <div style="margin-top: 5px;">${comment.comment}</div>
                                </div>
                            `).join('') :
                            '<p>No comments yet</p>'
                        }
                    </div>
                    <div class="form-group">
                        <label for="newComment">Add New Comment</label>
                        <textarea id="newComment" rows="3" style="width: 100%;"></textarea>
                    </div>
                    <div class="btn-group">
                        <button class="btn" onclick="saveNewComment('${taskId}')">Add Comment</button>
                        <button class="btn btn-secondary" onclick="hideCommentsModal()">Close</button>
                    </div>
                `;
                
                let modal = document.getElementById('commentsModal');
                if (!modal) {
                    modal = document.createElement('div');
                    modal.id = 'commentsModal';
                    modal.className = 'modal';
                    modal.innerHTML = `<div class="modal-content">${modalContent}</div>`;
                    document.body.appendChild(modal);
                } else {
                    modal.querySelector('.modal-content').innerHTML = modalContent;
                }
                
                modal.classList.add('show');
                
            } catch (error) {
                console.error("Error fetching comments:", error);
                showStatusMessage("Failed to load comments", 'error');
            }
        }

        async function saveNewComment(taskId) {
            const comment = document.getElementById('newComment').value.trim();
            if (!comment) return;
            
            try {
                await db.collection('taskComments').add({
                    taskId,
                    comment,
                    userId: userSync.currentUser.uid,
                    userName: currentUser.name,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                showStatusMessage('Comment added successfully!');
                viewTaskComments(taskId); // Refresh the comments view
            } catch (error) {
                console.error("Error adding comment:", error);
                showStatusMessage("Failed to add comment", 'error');
            }
        }

        function hideCommentsModal() {
            document.getElementById('commentsModal').classList.remove('show');
        }

        // Add comments button to task row
        function addCommentsButtonToTask(taskId) {
            return `<button class="btn btn-sm" onclick="viewTaskComments('${taskId}')">💬</button>`;
        }

        // ====================== TASK ATTACHMENTS ======================
        // Add function to upload attachments to tasks
        async function uploadTaskAttachment(taskId) {
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            
            fileInput.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                try {
                    showStatusMessage('Uploading attachment...');
                    
                    // Create a reference to the file location
                    const fileRef = storage.ref(`taskAttachments/${taskId}/${file.name}`);
                    
                    // Upload the file
                    await fileRef.put(file);
                    
                    // Get the download URL
                    const downloadURL = await fileRef.getDownloadURL();
                    
                    // Save the attachment reference to Firestore
                    await db.collection('taskAttachments').add({
                        taskId,
                        name: file.name,
                        type: file.type,
                        size: file.size,
                        url: downloadURL,
                        userId: userSync.currentUser.uid,
                        userName: currentUser.name,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    showStatusMessage('Attachment uploaded successfully!');
                    
                } catch (error) {
                    console.error("Error uploading attachment:", error);
                    showStatusMessage("Failed to upload attachment", 'error');
                }
            };
            
            fileInput.click();
        }

        async function viewTaskAttachments(taskId) {
            try {
                const attachmentsSnap = await db.collection('taskAttachments')
                    .where('taskId', '==', taskId)
                    .orderBy('timestamp', 'desc')
                    .get();
                
                const attachments = attachmentsSnap.docs.map(doc => doc.data());
                
                const modalContent = `
                    <h2>Task Attachments</h2>
                    <div style="max-height: 300px; overflow-y: auto; margin-bottom: 15px;">
                        ${attachments.length > 0 ? 
                            attachments.map(attachment => `
                                <div style="margin-bottom: 10px; padding: 10px; background: #f9fafb; border-radius: 5px;">
                                    <div style="font-weight: 500;">
                                        ${attachment.name} (${(attachment.size / 1024).toFixed(1)} KB)
                                    </div>
                                    <div style="font-size: 0.8em; color: #6b7280;">
                                        Uploaded by ${attachment.userName} on ${new Date(attachment.timestamp?.toDate()).toLocaleString()}
                                    </div>
                                    <div style="margin-top: 5px;">
                                        <a href="${attachment.url}" target="_blank" class="btn btn-sm">Download</a>
                                    </div>
                                </div>
                            `).join('') :
                            '<p>No attachments yet</p>'
                        }
                    </div>
                    <div class="btn-group">
                        <button class="btn" onclick="uploadTaskAttachment('${taskId}')">Add Attachment</button>
                        <button class="btn btn-secondary" onclick="hideAttachmentsModal()">Close</button>
                    </div>
                `;
                
                let modal = document.getElementById('attachmentsModal');
                if (!modal) {
                    modal = document.createElement('div');
                    modal.id = 'attachmentsModal';
                    modal.className = 'modal';
                    modal.innerHTML = `<div class="modal-content">${modalContent}</div>`;
                    document.body.appendChild(modal);
                } else {
                    modal.querySelector('.modal-content').innerHTML = modalContent;
                }
                
                modal.classList.add('show');
                
            } catch (error) {
                console.error("Error fetching attachments:", error);
                showStatusMessage("Failed to load attachments", 'error');
            }
        }

        function hideAttachmentsModal() {
            document.getElementById('attachmentsModal').classList.remove('show');
        }

        // Add attachments button to task row
        function addAttachmentsButtonToTask(taskId) {
            return `<button class="btn btn-sm" onclick="viewTaskAttachments('${taskId}')">📎</button>`;
        }

        // ====================== FINAL TASK ROW INTEGRATION ======================
        // Modify the renderTasks function to include all the new action buttons
        // Here's how the actions column might look now:
        /*
        <td>
            <div class="actions">
                ${hasPermission('edit') ? `
                    <button class="btn btn-sm" onclick="editTask('${task.id}')">✏️</button>
                    ${addDependenciesButtonToTask(task.id)}
                ` : ''}
                ${hasPermission('delete') ? `
                    <button class="btn btn-danger btn-sm" onclick="deleteTask('${task.id}')">🗑️</button>
                ` : ''}
                ${addHistoryButtonToTask(task.id)}
                ${addCommentsButtonToTask(task.id)}
                ${addAttachmentsButtonToTask(task.id)}
            </div>
        </td>
        */
    </script>
</body>
</html>
